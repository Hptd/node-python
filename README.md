# 简易中文节点Python编辑器

基于 PySide6 的图形化节点编辑器，允许用户通过拖拽和连接节点来创建可执行的数据流图。支持自定义 Python 节点函数、持久化存储和实时执行。

## 项目结构

```
node-python/
├── main.py                    # 应用入口，初始化 Qt 应用和主窗口
├── main_flow_2.py            # 流程图示例 2（备用入口）
├── main_flow_line.py         # 线性流程图示例（备用入口）
├── requirements.txt           # 依赖：PySide6>=6.5.0
├── project_structure.md       # 项目结构设计文档
├── AGENTS.md                 # 项目开发文档
├── config/                    # 配置文件
│   └── settings.py           # 应用配置管理（窗口状态、用户偏好等）
├── core/                      # 核心模块
│   ├── nodes/                # 节点相关
│   │   ├── base_nodes.py    # 内置节点函数（加法、打印、常量等）
│   │   └── node_library.py  # 节点库管理，分类存储
│   ├── graphics/             # 图形组件
│   │   ├── port_item.py     # 输入/输出端口
│   │   ├── connection_item.py # 连接线
│   │   ├── simple_node_item.py # 图形节点类
│   │   └── node_graphics_view.py # 画布视图（缩放、平移）
│   └── engine/               # 执行引擎
│       └── graph_executor.py # 拓扑排序和执行引擎
├── ui/                        # 用户界面
│   ├── dialogs/              # 对话框
│   │   ├── custom_node_dialog.py  # 自定义节点编辑器
│   │   ├── category_dialog.py     # 分类管理对话框
│   │   └── path_selector_dialog.py # 路径选择对话框
│   ├── widgets/              # 自定义控件
│   │   └── draggable_node_tree.py # 可拖拽节点列表
│   └── main_window.py        # 主窗口，工具栏和面板布局
├── storage/                   # 存储模块
│   ├── custom_node_storage.py # 自定义节点持久化
│   └── graph_storage.py      # 图表 JSON 保存/加载
└── utils/                     # 工具函数
    ├── console_stream.py     # 控制台输出重定向
    └── constants.py          # 颜色、尺寸等常量定义
```

## 功能特性

### 1. 可视化节点编辑
- **拖拽添加节点**：从左侧节点库拖拽节点到画布
- **双击添加**：双击节点库中的节点名称快速添加
- **右键菜单添加**：在画布空白处右键，通过分类菜单或搜索快速添加节点
- **连接节点**：从输出端口拖拽到输入端口建立连接
- **框选多选**：左键拖动框选多个节点
- **视图操作**：中键平移视图，滚轮缩放

### 2. 节点库管理
- **分类管理**：节点按分类组织（输出、常量、提取、Debug 等）
- **自定义分类**：支持新建自定义分类
- **自定义节点**：通过 Python 代码动态创建新节点
- **自动加载**：应用启动时自动加载自定义节点
- **右键菜单**：画布空白处右键显示分类菜单，支持中文搜索快速定位节点

### 3. 参数输入系统
- **属性面板编辑**：选中节点后在右侧面板直接输入参数值
- **智能控件匹配**：根据参数类型自动生成对应输入控件：
  - `bool` → QCheckBox（复选框）
  - `int` → QSpinBox（整数输入）
  - `float` → QDoubleSpinBox（浮点数输入）
  - 其他 → QLineEdit（文本输入）
- **参数持久化**：参数值随节点保存到 JSON
- **默认值支持**：使用函数参数默认值作为初始值

### 4. 节点属性查看
- **文档注释**：显示节点的文档字符串
- **源代码查看**：显示节点的 Python 源代码
- **自定义节点源码**：保存并显示自定义节点的原始代码

### 5. 自定义节点
- **代码编辑器**：内置 Python 代码编辑器
- **语法验证**：自动检查代码语法
- **自动端口生成**：基于函数签名自动生成输入/输出端口
- **分类选择**：可选择或创建新分类存放自定义节点

### 6. 持久化存储
- **自定义节点存储**：自动保存到 `.node-python/custom_nodes.json`
- **图表存储**：保存为 JSON 文件，支持路径选择和命名
- **完整状态保存**：包含节点位置、连接关系、参数值
- **打包兼容**：支持打包为 exe 后的相对路径访问
- **应用设置**：窗口状态、图形设置、执行选项等自动保存

### 7. 图表执行
- **拓扑排序**：自动确定节点执行顺序
- **参数解析**：优先使用连接值，否则使用预设参数值
- **实时输出**：执行结果实时显示在控制台
- **错误处理**：捕获并显示执行错误和堆栈跟踪

## 安装运行

### 环境要求
- Python 3.10+
- PySide6 >= 6.5.0

### 安装依赖
```bash
pip install -r requirements.txt
```

### 运行应用
```bash
python main.py
```

## 使用说明

### 基本操作

| 操作 | 说明 |
|------|------|
| 添加节点 | 从左侧节点库拖拽或双击节点名添加 |
| 右键菜单 | 在画布空白处右键，通过分类菜单或搜索添加节点 |
| 连接节点 | 从输出端口拖拽到输入端口 |
| 移动节点 | 拖拽节点到目标位置 |
| 删除节点 | 选中节点后按 Delete 键，或右键菜单删除 |
| 框选多选 | 左键拖动框选多个节点 |
| 平移视图 | 按住中键拖动 |
| 缩放视图 | 滚轮上下滚动 |
| 运行图表 | 点击工具栏 "▶ 运行" 按钮 |
| 停止执行 | 点击工具栏 "⏹ 停止" 按钮 |

### 参数输入

1. 在画布上**选中**一个节点
2. 在右侧 "📥 参数输入" 区域输入参数值
3. 参数值会自动保存到节点中
4. 执行时优先使用设置的值，如果端口已连接则使用连接值

### 保存和加载图表

- **保存图表**：点击工具栏 "💾 保存为 JSON"，选择路径和文件名
- **加载图表**：点击工具栏 "📂 加载 JSON"，选择之前保存的文件
- 图表保存包含：节点类型、位置、参数值、连接关系

### 新建分类

1. 点击左侧 "+ 新建分类" 按钮
2. 输入分类名称
3. 新分类会出现在节点库中，可用于存放自定义节点

### 创建自定义节点

1. 点击左侧 "+ 自定义节点" 按钮
2. 在代码编辑器中输入 Python 函数代码
3. 选择或创建分类
4. 点击生成节点，节点将立即出现在节点库中

### 自定义节点代码规范

```python
def 节点名(参数1: 类型, 参数2: 类型) -> 返回类型:
    """
    节点说明文档（显示在属性面板）。
    """
    return 结果
```

**规则**：
1. 必须定义且仅定义一个顶层函数
2. 函数名即为节点名
3. 参数类型决定输入控件的类型（bool/int/float/str）
4. 返回类型注解决定是否有输出端口
5. 代码必须是合法的 Python 语法

**示例**：
```python
def 乘法(a: int, b: int) -> int:
    """
    乘法运算节点。
    输入两个数字，返回它们的乘积。
    """
    return a * b
```

## 打包为可执行文件

使用 PyInstaller 打包：

```bash
pip install pyinstaller
pyinstaller --onefile --windowed --name node-editor main.py
```

打包后，自定义节点和设置将保存在可执行文件同级目录的 `.node-python` 文件夹中。

## 内置节点

### 输出
| 节点名 | 参数 | 返回值 | 说明 |
|--------|------|--------|------|
| **打印节点** | data: any | None | 将输入的数据打印到控制台 |

### 常量
所有常量节点都可在属性面板设置默认值：

| 节点名 | 参数 | 返回值 | 说明 |
|--------|------|--------|------|
| **布尔** | value: bool = True | bool | 返回布尔值 |
| **整数** | value: int = 0 | int | 返回整数值 |
| **浮点数** | value: float = 0.0 | float | 返回浮点数值 |
| **字符串** | value: str = "" | str | 返回字符串值 |
| **列表** | value: list = None | list | 返回列表值（默认空列表） |
| **字典** | value: dict = None | dict | 返回字典值（默认空字典） |

### 提取
| 节点名 | 参数 | 返回值 | 说明 |
|--------|------|--------|------|
| **数据提取** | data: any, key: any, default: any = None | any | 从数据结构中提取指定键的值，支持字典、列表、元组等 |

### Debug
| 节点名 | 参数 | 返回值 | 说明 |
|--------|------|--------|------|
| **数据类型检测** | data: any | str | 检测并返回输入数据的类型名称 |

## 配置系统

应用设置保存在 `.node-python/settings.json`，包含：

- **窗口设置**：尺寸、位置、最大化状态
- **图形设置**：缩放速度、网格显示、对齐选项
- **节点设置**：自动保存/加载自定义节点、删除确认
- **执行设置**：自动运行、显示执行时间、错误停止
- **UI 设置**：主题、字体大小、语言、工具提示
- **最近文件**：最近打开的图表文件列表

## 开发说明

### 添加内置节点

1. 在 `core/nodes/base_nodes.py` 中添加新的节点函数
2. 在 `core/nodes/node_library.py` 的 `NODE_LIBRARY_CATEGORIZED` 中注册分类

### 修改界面样式

在 `utils/constants.py` 中修改颜色常量：
- `COLOR_NODE_BG`：节点背景色
- `COLOR_INPUT_PORT`：输入端口颜色
- `COLOR_OUTPUT_PORT`：输出端口颜色

### 扩展功能

- **新节点类型**：修改 `base_nodes.py` 和 `node_library.py`
- **新存储格式**：在 `storage/` 中添加新模块
- **新对话框**：在 `ui/dialogs/` 中创建
- **执行逻辑**：在 `core/engine/graph_executor.py` 中扩展

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| Delete | 删除选中的节点 |
| 中键拖动 | 平移视图 |
| 滚轮 | 缩放视图 |
| 左键框选 | 多选节点 |

## 存储位置

- **设置文件**：`.node-python/settings.json`
- **自定义节点**：`.node-python/custom_nodes.json`
- **图表文件**：用户选择的 JSON 文件路径

## 许可证

MIT License