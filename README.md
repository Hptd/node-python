# 简易中文节点Python编辑器

基于 PySide6 的图形化节点编辑器，允许用户通过拖拽和连接节点来创建可执行的数据流图。支持自定义 Python 节点函数、持久化存储和实时执行。

![软件界面截图](logo/node-python-screenshot.png)

> 上图展示了软件的主界面，包含节点库、画布、属性面板和控制台等区域。

## 目录

- [功能特性](#功能特性)
- [安装运行](#安装运行)
- [使用教程](#使用教程)
- [界面说明](#界面说明)
- [快捷键](#快捷键)
- [打包说明](#打包说明)
- [开发文档](#开发文档)

## 功能特性

### 1. 可视化节点编辑
- **拖拽添加节点**：从左侧节点库拖拽节点到画布
- **双击添加**：双击节点库中的节点名称快速添加
- **右键菜单添加**：在画布空白处右键，通过分类菜单或搜索快速添加节点
- **连接节点**：从输出端口拖拽到输入端口建立连接
- **框选多选**：左键拖动框选多个节点
- **视图操作**：中键平移视图，滚轮缩放

### 2. 节点库管理
- **分类管理**：节点按分类组织（输出、常量、提取、Debug 等）
- **自定义分类**：支持新建自定义分类
- **自定义节点**：通过 Python 代码动态创建新节点
- **AI 生成节点**：使用 AI 辅助生成节点代码模板
- **自动加载**：应用启动时自动加载自定义节点
- **右键菜单**：画布空白处右键显示分类菜单，支持中文搜索快速定位节点

### 3. 参数输入系统
- **属性面板编辑**：选中节点后在右侧面板直接输入参数值
- **智能控件匹配**：根据参数类型自动生成对应输入控件：
  - `bool` → QCheckBox（复选框）
  - `int` → QSpinBox（整数输入）
  - `float` → QDoubleSpinBox（浮点数输入）
  - `list` → JSON 格式输入框
  - `dict` → JSON 格式输入框
  - 其他 → QLineEdit（文本输入）
- **参数持久化**：参数值随节点保存到 JSON
- **默认值支持**：使用函数参数默认值作为初始值

### 4. 节点属性查看
- **文档注释**：显示节点的文档字符串
- **源代码查看**：显示节点的 Python 源代码
- **自定义节点源码**：保存并显示自定义节点的原始代码

### 5. 自定义节点
- **代码编辑器**：内置 Python 代码编辑器
- **语法验证**：自动检查代码语法
- **自动端口生成**：基于函数签名自动生成输入/输出端口
- **分类选择**：可选择或创建新分类存放自定义节点

### 6. 主题切换
- **黑白双主题**：支持暗黑模式和明亮模式切换
- **一键切换**：点击工具栏主题按钮即可切换
- **自动保存**：主题设置自动保存，下次启动时恢复

### 7. 持久化存储
- **自定义节点存储**：自动保存到 `.node-python/custom_nodes.json`
- **图表存储**：保存为 JSON 文件，支持路径选择和命名
- **完整状态保存**：包含节点位置、连接关系、参数值
- **打包兼容**：支持打包为 exe 后的相对路径访问
- **应用设置**：窗口状态、图形设置、执行选项等自动保存

### 8. 图表执行
- **拓扑排序**：自动确定节点执行顺序
- **参数解析**：优先使用连接值，否则使用预设参数值
- **实时输出**：执行结果实时显示在控制台
- **错误处理**：捕获并显示执行错误和堆栈跟踪

## 安装运行

### 环境要求
- Python 3.10+
- PySide6 >= 6.5.0

### 安装依赖
```bash
pip install -r requirements.txt
```

### 运行应用
```bash
python main.py
```

## 使用教程

### 界面布局

软件界面分为五个主要区域：

1. **顶部工具栏**：包含运行控制、文件操作、环境管理和主题切换等功能按钮
2. **左侧节点库**：显示所有可用节点，按分类组织
3. **中央画布**：节点编辑区域，可拖拽、连接节点
4. **右侧面板**：显示选中节点的属性、参数输入、文档和源代码
5. **底部控制台**：显示执行输出和日志信息

### 工具栏按钮功能

| 按钮 | 功能说明 |
|------|----------|
| ▶ 运行 | 执行当前画布上的节点流程图 |
| ⏹ 停止 | 停止正在执行的流程 |
| 💾 保存为 JSON | 将当前图表保存为 JSON 文件 |
| 📂 加载 JSON | 从 JSON 文件加载图表 |
| 🤖 AI节点模板 | 打开 AI 节点生成器，辅助创建节点代码 |
| 📦 依赖管理 | 管理嵌入式 Python 环境的第三方库 |
| 🔧 初始化环境 | 初始化嵌入式 Python 环境 |
| 🌙/☀️ 切换主题 | 在暗黑模式和明亮模式之间切换 |

### 节点库操作

#### 添加节点到画布

**方法一：拖拽添加**
1. 在左侧节点库中找到需要的节点
2. 按住鼠标左键将节点拖拽到画布上
3. 松开鼠标，节点即被添加到画布

**方法二：双击添加**
1. 在节点库中双击节点名称
2. 节点会自动添加到画布中央

**方法三：右键菜单添加**
1. 在画布空白处点击右键
2. 在弹出的菜单中选择分类
3. 点击节点名称添加，或使用搜索框快速查找

#### 创建自定义分类

1. 点击左侧 "+ 新建分类" 按钮
2. 在弹出的对话框中输入分类名称
3. 点击确定，新分类会出现在节点库中

#### 创建自定义节点

1. 点击左侧 "+ 自定义节点" 按钮
2. 在代码编辑器中输入 Python 函数代码
3. 选择或创建分类
4. 点击生成节点，节点将立即出现在节点库中

**自定义节点代码规范**：
```python
def 节点名(参数1: 类型, 参数2: 类型) -> 返回类型:
    """
    节点说明文档（显示在属性面板）。
    """
    return 结果
```

**规则**：
1. 必须定义且仅定义一个顶层函数
2. 函数名即为节点名
3. 参数类型决定输入控件的类型（bool/int/float/str/list/dict）
4. 返回类型注解决定是否有输出端口
5. 代码必须是合法的 Python 语法

**示例**：
```python
def 乘法(a: int, b: int) -> int:
    """
    乘法运算节点。
    输入两个数字，返回它们的乘积。
    """
    return a * b
```

### 节点操作

#### 移动节点
- 在节点上按住左键拖动即可移动

#### 连接节点
1. 将鼠标移到源节点的输出端口（橙色圆点）
2. 按住左键拖动到目标节点的输入端口（蓝色圆点）
3. 松开鼠标，连接建立成功

#### 删除连接
- 在输入端口上双击左键，会断开该端口的所有连接

#### 删除节点
- **方法一**：选中节点后按 Delete 键
- **方法二**：右键点击节点，选择"删除"

#### 框选多节点
1. 在画布空白处按住左键
2. 拖动鼠标形成选择框
3. 框内的节点会被选中，可同时移动或删除

### 参数输入

1. 在画布上**单击选中**一个节点
2. 在右侧 "📥 参数输入" 区域会显示该节点的所有参数
3. 根据参数类型使用对应的控件输入值：
   - 布尔值：使用复选框
   - 整数：使用数字输入框
   - 浮点数：使用小数输入框
   - 列表/字典：使用 JSON 格式文本输入
   - 其他：使用文本输入框
4. 参数值会自动保存到节点中
5. 执行时优先使用设置的值，如果端口已连接则使用连接值

### 保存和加载图表

#### 保存图表
1. 点击工具栏 "💾 保存为 JSON" 按钮
2. 在弹出的对话框中选择保存位置和文件名
3. 点击保存，图表数据（节点、连接、参数值）将被保存

#### 加载图表
1. 点击工具栏 "📂 加载 JSON" 按钮
2. 选择之前保存的 JSON 文件
3. 点击打开，图表将被恢复到画布上

### 执行流程图

1. 确保节点已正确连接
2. 设置好各节点的参数值（如需要）
3. 点击工具栏 "▶ 运行" 按钮
4. 执行结果将显示在底部控制台
5. 如需停止执行，点击 "⏹ 停止" 按钮

### 主题切换

1. 点击工具栏右侧的 "🌙 切换主题"（暗黑模式）或 "☀️ 切换主题"（明亮模式）按钮
2. 界面颜色会立即切换
3. 主题设置会自动保存，下次启动时保持

### 依赖管理

#### 初始化环境
0. 如果使用压缩包解压，直接点击exe文件即可执行，压缩包内已经配置好与exe可执行文件的python环境包（python_embedded文件夹）。并且忽略后续的三个步骤。
1. 首次使用或需要重置环境时，点击 "🔧 初始化环境" 按钮
2. 程序会自动下载并配置嵌入式 Python 环境
3. 等待初始化完成即可使用

#### 安装第三方库
1. 点击 "📦 依赖管理" 按钮
2. 在弹出的对话框中输入要安装的包名（如 `requests`、`pandas` 等）
3. 点击安装，等待安装完成

### 控制台操作

- **设置日志路径**：点击 "📁 设置日志路径" 可更改日志文件保存位置
- **打开文件夹**：点击 "📂 打开文件夹" 可打开日志所在文件夹
- **清空控制台**：点击 "🗑️ 清空控制台" 可清空控制台显示内容

## 界面说明

### 节点颜色含义

| 颜色 | 含义 |
|------|------|
| 🟢 绿色节点 | 普通节点 |
| 🔵 蓝色端口 | 输入端口 |
| 🟠 橙色端口 | 输出端口 |
| 🟢 绿色连线 | 正常连接 |

### 内置节点

#### 输出
| 节点名 | 参数 | 返回值 | 说明 |
|--------|------|--------|------|
| **打印节点** | data: any | None | 将输入的数据打印到控制台 |

#### 常量
所有常量节点都可在属性面板设置默认值：

| 节点名 | 参数 | 返回值 | 说明 |
|--------|------|--------|------|
| **布尔** | value: bool = True | bool | 返回布尔值 |
| **整数** | value: int = 0 | int | 返回整数值 |
| **浮点数** | value: float = 0.0 | float | 返回浮点数值 |
| **字符串** | value: str = "" | str | 返回字符串值 |
| **列表** | value: list = None | list | 返回列表值（默认空列表） |
| **字典** | value: dict = None | dict | 返回字典值（默认空字典） |

#### 提取
| 节点名 | 参数 | 返回值 | 说明 |
|--------|------|--------|------|
| **数据提取** | data: any, key: any, default: any = None | any | 从数据结构中提取指定键的值，支持字典、列表、元组等 |

#### Debug
| 节点名 | 参数 | 返回值 | 说明 |
|--------|------|--------|------|
| **数据类型检测** | data: any | str | 检测并返回输入数据的类型名称 |

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| Delete / Backspace | 删除选中的节点 |
| 鼠标中键拖动 | 平移视图 |
| 鼠标滚轮 | 缩放视图 |
| 左键拖动框选 | 多选节点 |
| 右键点击画布 | 打开节点创建菜单 |

## 打包说明

### 打包为可执行文件

使用 PyInstaller 打包：

```bash
pip install pyinstaller
pyinstaller --onefile --windowed --name node-editor main.py
```

### 打包后的文件结构

打包后的理想产品形态：
```
node-editor.exe              # 主程序可执行文件
├── python_embedded/         # 外部 Python 运行环境（必需）
│   ├── python.exe          # 嵌入式 Python 解释器
│   ├── Lib/site-packages/  # 第三方库安装目录
│   └── ...                # 其他 Python 运行时文件
├── .node-python/           # 配置和自定义节点存储
│   ├── settings.json      # 应用设置
│   └── custom_nodes.json  # 自定义节点代码
└── output_logs/           # 日志输出目录
    └── output_log.txt    # 运行日志文件
```

### 运行环境说明

**重要更新**：所有节点（包括内置节点和自定义节点）现在都统一在外部 `python_embedded` 环境中执行。

- **exe文件**：只包含核心GUI和程序逻辑，不包含Python解释器
- **python_embedded文件夹**：独立的Python 3.10环境，位于exe同级目录
  - 可以通过工具栏的"📦 依赖管理"安装第三方库
  - 可以通过"🔧 初始化环境"重新下载和配置
- **.node-python文件夹**：存储用户设置和自定义节点
- **output_logs文件夹**：存储运行日志

## 开发文档

### 项目结构

```
node-python/
├── main.py                    # 应用入口
├── requirements.txt           # 依赖
├── config/                    # 配置管理
│   └── settings.py
├── core/                      # 核心模块
│   ├── nodes/                # 节点定义
│   ├── graphics/             # 图形组件
│   └── engine/               # 执行引擎
├── ui/                        # 用户界面
│   ├── dialogs/              # 对话框
│   ├── widgets/              # 自定义控件
│   └── main_window.py        # 主窗口
├── storage/                   # 存储模块
└── utils/                     # 工具函数
    ├── constants.py          # 常量定义
    ├── console_stream.py     # 控制台输出
    └── theme_manager.py      # 主题管理
```

### 添加内置节点

1. 在 `core/nodes/base_nodes.py` 中添加新的节点函数
2. 在 `core/nodes/node_library.py` 的 `NODE_LIBRARY_CATEGORIZED` 中注册分类

### 修改界面样式

主题颜色定义在 `utils/theme_manager.py` 中的 `THEMES` 字典中，可修改：
- `dark`：暗黑模式配色
- `light`：明亮模式配色

### 扩展功能

- **新节点类型**：修改 `base_nodes.py` 和 `node_library.py`
- **新存储格式**：在 `storage/` 中添加新模块
- **新对话框**：在 `ui/dialogs/` 中创建
- **执行逻辑**：在 `core/engine/graph_executor.py` 中扩展

## 配置系统

应用设置保存在 `.node-python/settings.json`，包含：

- **窗口设置**：尺寸、位置、最大化状态
- **图形设置**：缩放速度、网格显示、对齐选项
- **节点设置**：自动保存/加载自定义节点、删除确认
- **执行设置**：自动运行、显示执行时间、错误停止
- **UI 设置**：主题、字体大小、语言、工具提示
- **最近文件**：最近打开的图表文件列表

## 存储位置

- **设置文件**：`.node-python/settings.json`
- **自定义节点**：`.node-python/custom_nodes.json`
- **图表文件**：用户选择的 JSON 文件路径
- **日志文件**：`output_logs/output_log.txt`

## 许可证

MIT License
